name: 'Azure Login (OIDC + act Fallback)'
description: 'Login to Azure using OIDC in cloud, service principal fallback for local act testing'

inputs:
  client-id:
    description: 'Azure Client ID for OIDC'
    required: true
  tenant-id:
    description: 'Azure Tenant ID for OIDC'
    required: true
  subscription-id:
    description: 'Azure Subscription ID for OIDC'
    required: true
  client-secret:
    description: 'Azure Client Secret for service principal (used only with act)'
    required: false

runs:
  using: 'composite'
  steps:
    - name: Login to Azure (OIDC)
      if: ${{ !env.ACT }}
      uses: azure/login@v2
      with:
        client-id: ${{ inputs.client-id }}
        tenant-id: ${{ inputs.tenant-id }}
        subscription-id: ${{ inputs.subscription-id }}

    - name: Login to Azure (Service Principal for act)
      if: ${{ env.ACT }}
      shell: bash
      run: |
        set -e

        # Check if credentials are provided for local testing
        if [ -z "${{ inputs.client-id }}" ] || [ -z "${{ inputs.client-secret }}" ] || [ -z "${{ inputs.tenant-id }}" ]; then
          echo "⚠️  Warning: Azure credentials not fully provided for local testing"
          echo "⚠️  Azure login will be skipped (set ARM_CLIENT_ID, ARM_CLIENT_SECRET, ARM_TENANT_ID)"
          exit 0
        fi

        # Login to Azure using service principal
        az login --service-principal \
          -u "${{ inputs.client-id }}" \
          -p "${{ inputs.client-secret }}" \
          --tenant "${{ inputs.tenant-id }}" > /dev/null 2>&1

        # Set subscription
        az account set --subscription "${{ inputs.subscription-id }}" > /dev/null 2>&1

        echo "✅ Successfully logged in to Azure via service principal (act detected)"
