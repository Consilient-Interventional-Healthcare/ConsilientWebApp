name: 'Database Connectivity Health Check'
description: 'Verify database is reachable with Azure AD authentication before deployment'

inputs:
  sql-server:
    description: 'SQL Server FQDN (e.g., server.database.windows.net)'
    required: true
  database-name:
    description: 'Database name to check connectivity'
    required: true
  timeout:
    description: 'Connection timeout in seconds'
    required: false
    default: '30'
  auth-type:
    description: 'Authentication type: azure-ad or sql-auth'
    required: false
    default: 'azure-ad'
  sql-username:
    description: 'SQL Server authentication username (required if auth-type is sql-auth)'
    required: false
    default: ''
  sql-password:
    description: 'SQL Server authentication password (required if auth-type is sql-auth)'
    required: false
    default: ''

outputs:
  status:
    description: 'Health check status (healthy/failed)'
    value: ${{ steps.health-check.outputs.status }}
  database-name:
    description: 'Database name returned from DB_NAME() query'
    value: ${{ steps.health-check.outputs.database-name }}

runs:
  using: 'composite'
  steps:
    - name: Database Connectivity Health Check
      id: health-check
      shell: bash
      run: |
        set +e  # Don't exit immediately on error - we handle it ourselves

        SQL_SERVER="${{ inputs.sql-server }}"
        DATABASE_NAME="${{ inputs.database-name }}"
        TIMEOUT="${{ inputs.timeout }}"
        AUTH_TYPE="${{ inputs.auth-type }}"

        echo "================================================"
        echo "ðŸ” Database Connectivity Health Check"
        echo "================================================"
        echo "Server: ${SQL_SERVER}"
        echo "Database: ${DATABASE_NAME}"

        # Execute health check query with timeout based on auth-type
        if [ "$AUTH_TYPE" == "sql-auth" ]; then
          SQL_USERNAME="${{ inputs.sql-username }}"
          SQL_PASSWORD="${{ inputs.sql-password }}"

          # Validate credentials are provided
          if [ -z "$SQL_USERNAME" ] || [ -z "$SQL_PASSWORD" ]; then
            echo "âŒ ERROR: sql-username and sql-password are required when auth-type is sql-auth"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "database-name=" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "Auth: SQL Server Authentication (user: $SQL_USERNAME)"
          echo ""

          RESULT=$(timeout "$TIMEOUT" sqlcmd -S "$SQL_SERVER" \
            -d "$DATABASE_NAME" \
            -U "$SQL_USERNAME" \
            -P "$SQL_PASSWORD" \
            -i "${{ github.workspace }}/infra/db/health_check.sql" \
            -h -1 \
            -W \
            -b)

          EXIT_CODE=$?
        else
          echo "Auth: Azure AD (-G flag)"
          echo ""

          RESULT=$(timeout "$TIMEOUT" sqlcmd -S "$SQL_SERVER" \
            -d "$DATABASE_NAME" \
            -G \
            -i "${{ github.workspace }}/infra/db/health_check.sql" \
            -h -1 \
            -W \
            -b)

          EXIT_CODE=$?
        fi

        # Process result
        if [ $EXIT_CODE -eq 0 ]; then
          # Extract database name from result (remove whitespace)
          DB_NAME=$(echo "$RESULT" | grep -v "^-" | grep -v "^DatabaseName" | tr -d '[:space:]')

          if [ -n "$DB_NAME" ]; then
            echo "âœ… Database connectivity check PASSED"
            echo "   Connected to: $DB_NAME"
            echo "status=healthy" >> $GITHUB_OUTPUT
            echo "database-name=$DB_NAME" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Database connectivity check FAILED"
            echo "   Error: Query returned empty result"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "database-name=" >> $GITHUB_OUTPUT
            exit 1
          fi
        elif [ $EXIT_CODE -eq 124 ]; then
          echo "âŒ Database connectivity check FAILED"
          echo "   Error: Connection timed out after $TIMEOUT seconds"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "database-name=" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "âŒ Database connectivity check FAILED"
          echo "   Error: sqlcmd exited with code $EXIT_CODE"
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "database-name=" >> $GITHUB_OUTPUT
          exit 1
        fi
