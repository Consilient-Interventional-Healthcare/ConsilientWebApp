on:
  workflow_call:
    inputs:
      check_type:
        description: 'Type of health check to run (api or react)'
        required: true
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        type: string
      app_name:
        description: 'Azure Web App name'
        required: true
        type: string
      endpoint_url:
        description: 'Health check endpoint URL'
        required: true
        type: string
      resource_group:
        description: 'Azure Resource Group name (required for rollback)'
        required: true
        type: string
      previous_image:
        description: 'Previous container image for rollback'
        required: true
        type: string
      acr_registry:
        description: 'Azure Container Registry URL'
        required: true
        type: string
      wait_seconds:
        description: 'Seconds to wait for deployment to stabilize'
        required: false
        type: string
        default: '120'
      max_attempts:
        description: 'Maximum attempts for health check'
        required: false
        type: string
        default: '8'
      retry_delay:
        description: 'Delay between retry attempts'
        required: false
        type: string
        default: '15s'
      runs:
        description: 'Number of Lighthouse runs (React only)'
        required: false
        type: string
        default: '3'
      min_perf_score:
        description: 'Minimum performance score (React only)'
        required: false
        type: string
        default: '0.7'
      min_a11y_score:
        description: 'Minimum accessibility score (React only)'
        required: false
        type: string
        default: '0.9'
      min_bp_score:
        description: 'Minimum best practices score (React only)'
        required: false
        type: string
        default: '0.7'
      min_seo_score:
        description: 'Minimum SEO score (React only)'
        required: false
        type: string
        default: '0.7'
      runner_image:
        description: 'Docker image for the health check container'
        required: true
        type: string
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      AZURE_SUBSCRIPTION_ID:
        required: true
      AZURE_CREDENTIALS:
        required: false

permissions:
  contents: read
  id-token: write
  packages: read

jobs:
  health-check-api:
    name: API Health Check
    runs-on: ubuntu-latest
    if: ${{ inputs.check_type == 'api' }}
    environment: ${{ inputs.environment }}
    continue-on-error: ${{ inputs.environment == 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: API Health Check with Rollback
        uses: ./.github/actions/health-check-api
        with:
          app-name: ${{ inputs.app_name }}
          endpoint-url: ${{ inputs.endpoint_url }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure-credentials: ${{ secrets.AZURE_CREDENTIALS || '{}' }}
          resource-group: ${{ inputs.resource_group }}
          previous-image: ${{ inputs.previous_image }}
          acr-registry: ${{ inputs.acr_registry }}
          environment: ${{ inputs.environment }}
          wait-seconds: ${{ inputs.wait_seconds }}
          max-attempts: ${{ inputs.max_attempts }}
          retry-delay: ${{ inputs.retry_delay }}

  health-check-react:
    name: React Lighthouse Check
    runs-on: ubuntu-latest
    if: ${{ inputs.check_type == 'react' }}
    container:
      image: ${{ inputs.runner_image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    environment: ${{ inputs.environment }}
    continue-on-error: ${{ inputs.environment == 'dev' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Lighthouse Health Check with Rollback
        uses: ./.github/actions/health-check-lighthouse
        with:
          app-url: ${{ inputs.endpoint_url }}
          app-name: ${{ inputs.app_name }}
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          azure-credentials: ${{ secrets.AZURE_CREDENTIALS || '{}' }}
          resource-group: ${{ inputs.resource_group }}
          previous-image: ${{ inputs.previous_image }}
          acr-registry: ${{ inputs.acr_registry }}
          environment: ${{ inputs.environment }}
          wait-seconds: ${{ inputs.wait_seconds }}
          runs: ${{ inputs.runs }}
          min-perf-score: ${{ inputs.min_perf_score }}
          min-a11y-score: ${{ inputs.min_a11y_score }}
          min-bp-score: ${{ inputs.min_bp_score }}
          min-seo-score: ${{ inputs.min_seo_score }}
