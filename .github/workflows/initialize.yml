on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev/prod/etc)'
        required: false
        type: string
        default: ''
    outputs:
      environment:
        description: 'Computed deployment environment'
        value: ${{ jobs.initialize.outputs.environment }}
      runner_image:
        description: 'Docker image for the actions runner'
        value: ${{ jobs.initialize.outputs.runner_image }}

jobs:
  initialize:
    name: Initialize Workflow
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      environment: ${{ steps.setenv.outputs.environment }}
      runner_image: ${{ steps.runner-image.outputs.runner_image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment input
        uses: ./.github/actions/validate-inputs
        with:
          environment: ${{ inputs.environment || 'dev' }}

      - name: Set environment output
        id: setenv
        run: |
          ENVIRONMENT_INPUT="${{ inputs.environment }}"

          # Default to dev if no input
          if [ -z "$ENVIRONMENT_INPUT" ]; then
            ENVIRONMENT_INPUT="dev"
          fi

          echo "environment=$ENVIRONMENT_INPUT" >> $GITHUB_OUTPUT

      - name: Compute runner image path
        id: runner-image
        run: |
          # Convert repository to lowercase (Docker requirement)
          REPO_LOWERCASE=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          RUNNER_IMAGE="${{ vars.CONTAINER_REGISTRY }}/${REPO_LOWERCASE}/actions-runner:latest"
          echo "runner_image=${RUNNER_IMAGE}" >> $GITHUB_OUTPUT
          echo "Runner image: ${RUNNER_IMAGE}"

      - name: Summary
        run: |
          echo "### Workflow Initialization Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ steps.setenv.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Runner Image:** \`${{ steps.runner-image.outputs.runner_image }}\`" >> $GITHUB_STEP_SUMMARY
