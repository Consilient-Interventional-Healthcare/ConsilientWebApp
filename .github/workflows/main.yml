name: Consilient Deployment Pipeline

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      run-databases:
        description: 'Run database deployment'
        required: false
        type: boolean
        default: true
      recreate-database-objects:
        description: 'Recreate all database objects (DELETE ALL DATA - dev only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read
  id-token: write
  pages: write
  packages: write

concurrency:
  group: main-${{ github.ref }}
  cancel-in-progress: true

# Global configuration variables
# To customize these values, set them as repository/organization variables in GitHub:
# - AZURE_REGION
# - AZURE_RESOURCE_GROUP
# - CONTAINER_REGISTRY


jobs:
  initialize-workflow:
    name: Initialize Workflow
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      environment: ${{ steps.initialize.outputs.environment }}
      # Database discovery outputs (merged from discover-databases job)
      database_directories: ${{ steps.discover.outputs.database_directories }}
      database_configs: ${{ steps.discover.outputs.database_configs }}
      database_count: ${{ steps.discover.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Initialize configuration
        id: initialize
        uses: ./.github/actions/initialize
        with:
          environment: 'dev'

      - name: Discover databases
        id: discover
        uses: ./.github/actions/discover-databases
        with:
          scripts_path: 'src/Databases'

  detect-changes:
    name: Detect Changes
    needs: [initialize-workflow]
    runs-on: ubuntu-latest
    outputs:
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
      databases: ${{ steps.filter.outputs.databases }}
      dotnet: ${{ steps.filter.outputs.dotnet }}
      react: ${{ steps.filter.outputs.react }}
      any_changes: ${{ steps.filter.outputs.infrastructure == 'true' || steps.filter.outputs.databases == 'true' || steps.filter.outputs.dotnet == 'true' || steps.filter.outputs.react == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infrastructure:
              - 'infra/terraform/**/*.tf'
              - 'infra/terraform/**/*.tfvars'
            databases:
              - 'src/Databases/**'
            dotnet:
              - 'src/Consilient.!(WebApp|WebApp2)/**'
            react:
              - 'src/Consilient.WebApp2/**'

  build-runner-image:
    name: Image Runner
    needs: [detect-changes]
    if: github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.any_changes == 'true'
    uses: ./.github/workflows/build-docker-image.yml
    with:
      image_type: actions-runner
    permissions:
      contents: read
      packages: write
    secrets: inherit

  warm-docker-cache:
    name: Warm Docker Cache
    needs: [initialize-workflow, build-runner-image]
    # DISABLED: This job adds ~69s but doesn't reduce downstream container init times.
    # Each container job still pulls the image independently. Re-enable after investigating
    # GitHub Actions container caching or self-hosted runners with pre-pulled images.
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.CONTAINER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image with layer caching
        run: |
          echo "üê≥ Pre-pulling Docker image with layer caching..."
          echo "Image: ${{ needs.build-runner-image.outputs.image_tag }}"

          # Use docker buildx with caching to pull and cache layers locally
          docker buildx build --load --cache-from=type=gha --cache-to=type=gha,mode=max \
            --build-arg BASE_IMAGE="${{ needs.build-runner-image.outputs.image_tag }}" \
            -f - . <<'EOF'
          ARG BASE_IMAGE
          FROM ${BASE_IMAGE}
          EOF

          echo "‚úÖ Docker image cached successfully"

      - name: Summary
        run: |
          echo "### Docker Cache Warming Complete ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ needs.build-runner-image.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Cache Status:** ‚úÖ Layer caching enabled (GHA)" >> $GITHUB_STEP_SUMMARY

  terraform:
    name: Terraform
    needs: [initialize-workflow, build-runner-image, warm-docker-cache, detect-changes]
    # Run when: changes detected OR manual dispatch with run-terraform enabled
    # Note: always() is required to evaluate this condition when warm-docker-cache is skipped (if: false)
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.any_changes == 'true') &&
      (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.infrastructure == 'true') &&
      (needs.build-runner-image.result == 'success' || needs.build-runner-image.result == 'skipped') &&
      (needs.warm-docker-cache.result == 'success' || needs.warm-docker-cache.result == 'skipped')
    uses: ./.github/workflows/terraform.yml
    with:
      environment: ${{ needs.initialize-workflow.outputs.environment }}
      allow-local-firewall: false
      enable-debug: false
      enable-oauth: false
      runner_image: ${{ needs.build-runner-image.outputs.image_tag }}
    secrets: inherit

  terraform-outputs:
    name: Terraform Outputs
    needs: [initialize-workflow, detect-changes, build-runner-image]
    # Run when: recreate-database-objects is true OR (not manual dispatch AND changes detected but no infra changes)
    if: |
      always() &&
      (
        (github.event_name == 'workflow_dispatch' && inputs.recreate-database-objects == true) ||
        (github.event_name != 'workflow_dispatch' && needs.detect-changes.outputs.any_changes == 'true' && needs.detect-changes.outputs.infrastructure != 'true')
      )
    uses: ./.github/workflows/terraform-outputs.yml
    with:
      environment: ${{ needs.initialize-workflow.outputs.environment }}
    secrets: inherit

  terraform-consolidation:
    name: Terraform Consolidation
    needs: [terraform, terraform-outputs]
    if: always() && (needs.terraform.result == 'success' || needs.terraform-outputs.result == 'success')
    runs-on: ubuntu-latest
    outputs:
      api_app_name: ${{ needs.terraform.outputs.api_app_name || needs.terraform-outputs.outputs.api_app_name }}
      react_app_name: ${{ needs.terraform.outputs.react_app_name || needs.terraform-outputs.outputs.react_app_name }}
      acr_registry_url: ${{ needs.terraform.outputs.acr_registry_url || needs.terraform-outputs.outputs.acr_registry_url }}
      resource_group_name: ${{ needs.terraform.outputs.resource_group_name || needs.terraform-outputs.outputs.resource_group_name }}
      sql_server_fqdn: ${{ needs.terraform.outputs.sql_server_fqdn || needs.terraform-outputs.outputs.sql_server_fqdn }}
    steps:
      - name: Consolidate outputs
        run: |
          echo "### Terraform Outputs Consolidated ‚úÖ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** ${{ needs.terraform.result == 'success' && 'terraform.yml (full)' || 'terraform-outputs.yml (lightweight)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Outputs:**" >> $GITHUB_STEP_SUMMARY
          echo "- API App: \`${{ needs.terraform.outputs.api_app_name || needs.terraform-outputs.outputs.api_app_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- React App: \`${{ needs.terraform.outputs.react_app_name || needs.terraform-outputs.outputs.react_app_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- ACR Registry: \`${{ needs.terraform.outputs.acr_registry_url || needs.terraform-outputs.outputs.acr_registry_url }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Resource Group: \`${{ needs.terraform.outputs.resource_group_name || needs.terraform-outputs.outputs.resource_group_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- SQL Server: \`${{ needs.terraform.outputs.sql_server_fqdn || needs.terraform-outputs.outputs.sql_server_fqdn }}\`" >> $GITHUB_STEP_SUMMARY

  deploy-databases:
    name: Deploy Databases
    needs: [initialize-workflow, detect-changes, terraform-consolidation, build-runner-image, warm-docker-cache]
    if: |
      (github.event_name != 'workflow_dispatch' || inputs.run-databases != false) &&
      (inputs.recreate-database-objects == true || github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.databases == 'true') &&
      always() &&
      (needs.build-runner-image.result == 'success' || needs.build-runner-image.result == 'skipped') &&
      needs.terraform-consolidation.result == 'success' &&
      (needs.warm-docker-cache.result == 'success' || needs.warm-docker-cache.result == 'skipped') &&
      needs.initialize-workflow.outputs.database_count != '0'
    uses: ./.github/workflows/databases.yml
    with:
      environment: ${{ needs.initialize-workflow.outputs.environment }}
      databases: ${{ needs.initialize-workflow.outputs.database_directories }}
      recreate-database-objects: ${{ inputs.recreate-database-objects || false }}
      azure-sql-server-fqdn: ${{ needs.terraform-consolidation.outputs.sql_server_fqdn }}
      runner_image: ${{ needs.build-runner-image.outputs.image_tag }}
    secrets: inherit


  deploy-dotnet-apps:
    name: Deploy API
    needs: [initialize-workflow, detect-changes, terraform-consolidation, deploy-databases, warm-docker-cache]
    if: |
      (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.dotnet == 'true') &&
      always() &&
      needs.terraform-consolidation.result == 'success' &&
      (needs.deploy-databases.result == 'success' || needs.deploy-databases.result == 'skipped') &&
      (needs.warm-docker-cache.result == 'success' || needs.warm-docker-cache.result == 'skipped')
    uses: ./.github/workflows/dotnet-apps.yml
    with:
      environment: ${{ needs.initialize-workflow.outputs.environment }}
      api_app_name: ${{ needs.terraform-consolidation.outputs.api_app_name || format('consilient-api-{0}', needs.initialize-workflow.outputs.environment) }}
      acr_registry: ${{ needs.terraform-consolidation.outputs.acr_registry_url }}
      resource_group: ${{ needs.terraform-consolidation.outputs.resource_group_name }}
      api_image_name: 'consilient-api'
      cache_image_ref: ${{ format('{0}/consilient-api:latest', needs.terraform-consolidation.outputs.acr_registry_url) }}
    secrets: inherit

  deploy-react-apps:
    name: Deploy React
    needs: [initialize-workflow, detect-changes, terraform-consolidation, deploy-databases, build-runner-image, warm-docker-cache]
    if: |
      (github.event_name == 'workflow_dispatch' || needs.detect-changes.outputs.react == 'true') &&
      always() &&
      (needs.build-runner-image.result == 'success' || needs.build-runner-image.result == 'skipped') &&
      needs.terraform-consolidation.result == 'success' &&
      (needs.deploy-databases.result == 'success' || needs.deploy-databases.result == 'skipped') &&
      (needs.warm-docker-cache.result == 'success' || needs.warm-docker-cache.result == 'skipped')
    uses: ./.github/workflows/react-apps.yml
    with:
      environment: ${{ needs.initialize-workflow.outputs.environment }}
      react_app_name: ${{ needs.terraform-consolidation.outputs.react_app_name || format('consilient-react-{0}', needs.initialize-workflow.outputs.environment) }}
      acr_registry: ${{ needs.terraform-consolidation.outputs.acr_registry_url }}
      resource_group: ${{ needs.terraform-consolidation.outputs.resource_group_name }}
      runner_image: ${{ needs.build-runner-image.outputs.image_tag }}
      react_image_name: 'consilient-react'
      cache_image_ref: ${{ format('{0}/consilient-react:latest', needs.terraform-consolidation.outputs.acr_registry_url) }}
    secrets: inherit

  # ============================================================================
  # WORKFLOW SUMMARY
  # ============================================================================

  workflow-summary:
    name: Workflow Summary
    needs: [initialize-workflow, detect-changes, terraform, terraform-outputs, terraform-consolidation, deploy-databases, deploy-dotnet-apps, deploy-react-apps]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.detect-changes.outputs.any_changes }}" != "true" && "${{ github.event_name }}" != "workflow_dispatch" ]]; then
            echo "> **No changes detected** - workflow short-circuited" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect Changes | ${{ needs.detect-changes.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform | ${{ needs.terraform.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Outputs | ${{ needs.terraform-outputs.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy Databases | ${{ needs.deploy-databases.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy API | ${{ needs.deploy-dotnet-apps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy React | ${{ needs.deploy-react-apps.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- Infrastructure: ${{ needs.detect-changes.outputs.infrastructure }}" >> $GITHUB_STEP_SUMMARY
          echo "- Databases: ${{ needs.detect-changes.outputs.databases }}" >> $GITHUB_STEP_SUMMARY
          echo "- .NET API: ${{ needs.detect-changes.outputs.dotnet }}" >> $GITHUB_STEP_SUMMARY
          echo "- React App: ${{ needs.detect-changes.outputs.react }}" >> $GITHUB_STEP_SUMMARY

      - name: Notify Teams
        env:
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
          ENVIRONMENT: ${{ needs.initialize-workflow.outputs.environment }}
          API_APP_NAME: ${{ needs.terraform-consolidation.outputs.api_app_name }}
          REACT_APP_NAME: ${{ needs.terraform-consolidation.outputs.react_app_name }}
        run: |
          # Skip if webhook URL is not configured
          if [[ -z "$TEAMS_WEBHOOK_URL" ]]; then
            echo "TEAMS_WEBHOOK_URL not configured, skipping Teams notification"
            exit 0
          fi

          # Function to get emoji for job status
          get_status_icon() {
            case "$1" in
              success)  echo "‚úÖ" ;;
              failure)  echo "‚ùå" ;;
              skipped)  echo "‚è≠Ô∏è" ;;
              cancelled) echo "üö´" ;;
              *)        echo "‚ö™" ;;
            esac
          }

          # Determine overall status
          if [[ "${{ needs.terraform.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-databases.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-dotnet-apps.result }}" == "failure" ]] || \
             [[ "${{ needs.deploy-react-apps.result }}" == "failure" ]]; then
            STATUS="Failed"
            COLOR="FF0000"
          else
            STATUS="Succeeded"
            COLOR="00FF00"
          fi

          # Environment tag (uppercase for visibility)
          ENV_TAG=$(echo "$ENVIRONMENT" | tr '[:lower:]' '[:upper:]')

          # Build app URLs from app names (Azure App Service URLs)
          API_URL="https://${API_APP_NAME}.azurewebsites.net"
          REACT_URL="https://${REACT_APP_NAME}.azurewebsites.net"

          # Get status icons for each job
          TF_ICON=$(get_status_icon "${{ needs.terraform.result }}")
          DB_ICON=$(get_status_icon "${{ needs.deploy-databases.result }}")
          API_ICON=$(get_status_icon "${{ needs.deploy-dotnet-apps.result }}")
          REACT_ICON=$(get_status_icon "${{ needs.deploy-react-apps.result }}")

          # Build API status with URL if successful
          if [[ "${{ needs.deploy-dotnet-apps.result }}" == "success" ]]; then
            API_VALUE="${API_ICON} [${{ needs.deploy-dotnet-apps.result }}](${API_URL})"
          else
            API_VALUE="${API_ICON} ${{ needs.deploy-dotnet-apps.result }}"
          fi

          # Build React status with URL if successful
          if [[ "${{ needs.deploy-react-apps.result }}" == "success" ]]; then
            REACT_VALUE="${REACT_ICON} [${{ needs.deploy-react-apps.result }}](${REACT_URL})"
          else
            REACT_VALUE="${REACT_ICON} ${{ needs.deploy-react-apps.result }}"
          fi

          curl -H "Content-Type: application/json" -d '{
            "@type": "MessageCard",
            "themeColor": "'"$COLOR"'",
            "summary": "['"$ENV_TAG"'] Workflow '"$STATUS"'",
            "sections": [{
              "activityTitle": "['"$ENV_TAG"'] Consilient Deployment Pipeline - '"$STATUS"'",
              "facts": [
                { "name": "Environment", "value": "**'"$ENV_TAG"'**" },
                { "name": "Repository", "value": "${{ github.repository }}" },
                { "name": "Branch", "value": "${{ github.ref_name }}" },
                { "name": "Triggered by", "value": "${{ github.actor }}" },
                { "name": "Terraform", "value": "'"$TF_ICON"' ${{ needs.terraform.result }}" },
                { "name": "Databases", "value": "'"$DB_ICON"' ${{ needs.deploy-databases.result }}" },
                { "name": "API", "value": "'"$API_VALUE"'" },
                { "name": "React", "value": "'"$REACT_VALUE"'" }
              ],
              "markdown": true
            }],
            "potentialAction": [
              { "@type": "OpenUri", "name": "View Run", "targets": [{ "os": "default", "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" }] },
              { "@type": "OpenUri", "name": "Open API", "targets": [{ "os": "default", "uri": "'"$API_URL"'" }] },
              { "@type": "OpenUri", "name": "Open React App", "targets": [{ "os": "default", "uri": "'"$REACT_URL"'" }] }
            ]
          }' "$TEAMS_WEBHOOK_URL"
