on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - prod
      run-terraform:
        description: 'Run Terraform deployment'
        required: false
        type: boolean
        default: true
      run-databases:
        description: 'Run database deployment'
        required: false
        type: boolean
        default: true
      recreate-database-objects:
        description: 'Recreate all database objects (DELETE ALL DATA - dev only)'
        required: false
        type: boolean
        default: false
      allow-local-firewall:
        description: 'Allow local firewall rule for SQL Server (act testing only - INSECURE)'
        required: false
        type: boolean
        default: false
      run-health-checks:
        description: 'Run health checks after deployment'
        required: false
        type: boolean
        default: true
      run-db-docs:
        description: 'Run database documentation generation'
        required: false
        type: boolean
        default: true
      run-api-deployment:
        description: 'Run .NET API deployment'
        required: false
        type: boolean
        default: true
      run-react-deployment:
        description: 'Run React app deployment'
        required: false
        type: boolean
        default: true
      enable-debug:
        description: 'Enable verbose debug logging and detailed workflow output'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  pull-requests: read
  id-token: write
  pages: write
  packages: write

concurrency:
  group: main-${{ github.ref }}
  cancel-in-progress: true

# Global configuration variables
# To customize these values, set them as repository/organization variables in GitHub:
# - AZURE_REGION
# - AZURE_RESOURCE_GROUP
# - DB_SCRIPTS_PATH # This is now less critical for workflow_dispatch, as it's an input

jobs:
  validate-environment:
    name: Validate Env
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      environment: ${{ steps.setenv.outputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate environment input
        uses: ./.github/actions/validate-inputs
        with:
          environment: ${{ github.event.inputs.environment || 'dev' }}

      - name: Set environment output
        id: setenv
        run: |
          ENVIRONMENT_INPUT="${{ github.event.inputs.environment }}"

          # Default to dev if no input (for non-dispatch events)
          if [ -z "$ENVIRONMENT_INPUT" ]; then
            ENVIRONMENT_INPUT="dev"
          fi

          echo "environment=$ENVIRONMENT_INPUT" >> $GITHUB_OUTPUT

  # ============================================================================
  # RUNNER IMAGE MANAGEMENT
  # ============================================================================
  # Ensures the custom runner image exists before running workflows that depend
  # on it (terraform, react_apps, healthchecks). The build-runner-image workflow
  # now handles existence checking internally and only builds if needed.
  # ============================================================================

  build-runner-image:
    name: Build Image if it doesn't exist
    needs: [validate-environment]
    uses: ./.github/workflows/build-runner-image.yml
    permissions:
      contents: read
      packages: write
    secrets: inherit

  terraform:
    name: Terraform
    needs: [build-runner-image, discover-databases]
    if: |
      (inputs.run-terraform != false) &&
      always() &&
      (needs.build-runner-image.result == 'success' || needs.build-runner-image.result == 'skipped') &&
      (needs.discover-databases.result == 'success' || needs.discover-databases.result == 'skipped')
    uses: ./.github/workflows/terraform.yml
    with:
      environment: ${{ needs.validate-environment.outputs.environment }}
      action: apply
      allow-local-firewall: ${{ inputs.allow-local-firewall || false }}
      enable-debug: ${{ inputs.enable-debug || false }}
    secrets: inherit

  # ============================================================================
  # DATABASE MANAGEMENT: Discovery, Deployment, and Documentation
  # ============================================================================
  # This section handles all database-related operations:
  # 1. discover-databases: Scans for databases and prepares metadata
  # 2. deploy-databases: Deploys discovered databases
  # 3. generate-db-docs: Generates documentation for configured databases
  # ============================================================================

  discover-databases:
    name: Discover DBs
    needs: [validate-environment]
    runs-on: ubuntu-latest
    outputs:
      database_directories: ${{ steps.discover.outputs.database_directories }}
      database_configs: ${{ steps.discover.outputs.database_configs }}
      count: ${{ steps.discover.outputs.count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Discover databases
        id: discover
        uses: ./.github/actions/discover-databases
        with:
          scripts_path: 'src/Databases'

  deploy-databases:
    name: Deploy DBs
    needs: [discover-databases, terraform]
    if: |
      (inputs.run-databases != false) &&
      always() &&
      needs.discover-databases.result == 'success' &&
      needs.discover-databases.outputs.count != '0'
    uses: ./.github/workflows/databases.yml
    with:
      environment: ${{ needs.validate-environment.outputs.environment }}
      databases: ${{ needs.discover-databases.outputs.database_directories }}
      recreate-database-objects: ${{ inputs.recreate-database-objects || false }}
    secrets: inherit

  generate-db-docs:
    name: DB Docs
    needs: [deploy-databases]
    if: |
      (inputs.run-db-docs != false) &&
      (github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch') &&
      always() &&
      needs.validate-environment.result == 'success' &&
      needs.discover-databases.result == 'success' &&
      needs.discover-databases.outputs.count != '0'
    uses: ./.github/workflows/docs_db.yml
    with:
      environment: ${{ needs.validate-environment.outputs.environment }}
      database-configs: ${{ needs.discover-databases.outputs.database_configs }}
    secrets: inherit

  # ============================================================================
  # END DATABASE MANAGEMENT SECTION
  # ============================================================================

  deploy-dotnet-apps:
    name: Deploy API
    needs: [terraform, deploy-databases]
    if: |
      (inputs.run-api-deployment != false) &&
      always() &&
      (needs.terraform.result == 'success' || needs.terraform.result == 'skipped') &&
      (needs.deploy-databases.result == 'success' || needs.deploy-databases.result == 'skipped')
    uses: ./.github/workflows/dotnet_apps.yml
    with:
      environment: ${{ needs.validate-environment.outputs.environment }}
      api_app_name: ${{ needs.terraform.outputs.api_app_name || format('consilient-api-{0}', needs.validate-environment.outputs.environment) }}
      acr_registry: ${{ needs.terraform.outputs.acr_registry_url || vars.ACR_REGISTRY_URL }}
      resource_group: ${{ needs.terraform.outputs.resource_group_name || vars.AZURE_RESOURCE_GROUP_NAME }}
    secrets: inherit

  deploy-react-apps:
    name: Deploy React
    needs: [deploy-dotnet-apps]
    if: |
      (inputs.run-react-deployment != false) &&
      always() &&
      (needs.deploy-dotnet-apps.result == 'success' || needs.deploy-dotnet-apps.result == 'skipped')
    uses: ./.github/workflows/react_apps.yml
    with:
      environment: ${{ needs.validate-environment.outputs.environment }}
      react_app_name: ${{ needs.terraform.outputs.react_app_name || format('consilient-react-{0}', needs.validate-environment.outputs.environment) }}
      acr_registry: ${{ needs.terraform.outputs.acr_registry_url || vars.ACR_REGISTRY_URL }}
      resource_group: ${{ needs.terraform.outputs.resource_group_name || vars.AZURE_RESOURCE_GROUP_NAME }}
    secrets: inherit

  health-check-api:
    name: API Health Check
    needs: [deploy-dotnet-apps]
    if: |
      (inputs.run-health-checks != false) &&
      (inputs.run-api-deployment != false) &&
      always() &&
      (needs.deploy-dotnet-apps.result == 'success')
    uses: ./.github/workflows/healthchecks.yml
    with:
      check_type: 'api'
      environment: ${{ needs.validate-environment.outputs.environment }}
      app_name: ${{ needs.deploy-dotnet-apps.outputs.api_app_name }}
      endpoint_url: https://${{ needs.deploy-dotnet-apps.outputs.api_app_name }}.azurewebsites.net/health
      resource_group: ${{ needs.terraform.outputs.resource_group_name || vars.AZURE_RESOURCE_GROUP_NAME }}
      previous_image: ${{ needs.deploy-dotnet-apps.outputs.previous_image }}
      acr_registry: ${{ needs.terraform.outputs.acr_registry_url || vars.ACR_REGISTRY_URL }}
      wait_seconds: '120'
      max_attempts: '8'
      retry_delay: '15s'
    secrets: inherit

  health-check-react:
    name: React Health Check
    needs: [deploy-react-apps]
    if: |
      (inputs.run-health-checks != false) &&
      (inputs.run-react-deployment != false) &&
      always() &&
      (needs.deploy-react-apps.result == 'success')
    uses: ./.github/workflows/healthchecks.yml
    with:
      check_type: 'react'
      environment: ${{ needs.validate-environment.outputs.environment }}
      app_name: ${{ needs.deploy-react-apps.outputs.react_app_name }}
      endpoint_url: https://${{ needs.deploy-react-apps.outputs.react_app_name }}.azurewebsites.net
      resource_group: ${{ needs.terraform.outputs.resource_group_name || vars.AZURE_RESOURCE_GROUP_NAME }}
      previous_image: ${{ needs.deploy-react-apps.outputs.previous_image }}
      acr_registry: ${{ needs.terraform.outputs.acr_registry_url || vars.ACR_REGISTRY_URL }}
      wait_seconds: '120'
      runs: '3'
      min_perf_score: '0.7'
      min_a11y_score: '0.9'
      min_bp_score: '0.7'
      min_seo_score: '0.7'
    secrets: inherit

  # Determine what changed to optimize workflow execution
#   detect-changes:
#     name: Detect Changes
#     runs-on: ubuntu-latest
#     needs: [setup-prerequisites]
#     outputs:
#       infrastructure: ${{ steps.filter.outputs.infrastructure }}
#       database: ${{ steps.filter.outputs.database }}
#       frontend: ${{ steps.filter.outputs.frontend }}
#       backend: ${{ steps.filter.outputs.backend }}
#       workflows: ${{ steps.filter.outputs.workflows }}
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Detect file changes
#         uses: dorny/paths-filter@v3
#         id: filter
#         with:
#           filters: |
#             infrastructure:
#               - 'infra/**'
#               - 'terraform/**'
#             database:
#               - 'src/Databases/**/*.sql'
#               - 'infra/db/**'
#             frontend:
#               - 'src/client/**'
#               - 'src/web/**'
#               - '**/package.json'
#               - '**/package-lock.json'
#             backend:
#               - 'src/server/**'
#               - 'src/api/**'
#               - '**/*.csproj'
#               - '**/*.cs'
#             workflows:
#               - '.github/workflows/**'

#   # Build and test frontend
#   build-frontend:
#     name: Build Frontend
#     needs: [setup-prerequisites, detect-changes]
#     if: needs.detect-changes.outputs.frontend == 'true'
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 20
#           cache: 'npm'
#           cache-dependency-path: '**/package-lock.json'

#       - name: Install dependencies
#         run: |
#           if [ -f "package-lock.json" ]; then
#             npm ci
#           elif [ -f "package.json" ]; then
#             npm install
#           fi

#       - name: Build frontend
#         run: |
#           if [ -f "package.json" ] && grep -q '"build"' package.json; then
#             npm run build
#           else
#             echo "No build script found, skipping"
#           fi

#       - name: Run tests
#         run: |
#           if [ -f "package.json" ] && grep -q '"test"' package.json; then
#             npm test -- --passWithNoTests || echo "No tests found"
#           else
#             echo "No test script found, skipping"
#           fi

#   # Build and test backend
#   build-backend:
#     name: Build Backend
#     needs: [setup-prerequisites, detect-changes]
#     if: needs.detect-changes.outputs.backend == 'true'
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup .NET
#         uses: actions/setup-dotnet@v4
#         with:
#           dotnet-version: '8.x'

#       - name: Restore dependencies
#         run: |
#           if ls *.sln 1> /dev/null 2>&1; then
#             dotnet restore
#           elif ls **/*.csproj 1> /dev/null 2>&1; then
#             dotnet restore **/*.csproj
#           else
#             echo "No .NET project files found"
#           fi

#       - name: Build backend
#         run: |
#           if ls *.sln 1> /dev/null 2>&1; then
#             dotnet build --no-restore --configuration Release
#           elif ls **/*.csproj 1> /dev/null 2>&1; then
#             dotnet build **/*.csproj --no-restore --configuration Release
#           else
#             echo "No .NET project files found"
#           fi

#       - name: Run tests
#         run: |
#           if ls **/*Tests.csproj 1> /dev/null 2>&1 || ls **/*Test.csproj 1> /dev/null 2>&1; then
#             dotnet test --no-build --configuration Release --verbosity normal
#           else
#             echo "No test projects found"
#           fi

#   # Summary job - always runs
#   workflow-summary:
#     name: Workflow Summary
#     runs-on: ubuntu-latest
#     needs: [setup-prerequisites, detect-changes, build-frontend, build-backend]
#     if: always()
#     steps:
#       - name: Create workflow summary
#         run: |
#           echo "# Workflow Execution Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "## Run Information" >> $GITHUB_STEP_SUMMARY
#           echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
#           echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY

#           echo "## Changes Detected" >> $GITHUB_STEP_SUMMARY
#           echo "- Infrastructure: ${{ needs.detect-changes.outputs.infrastructure == 'true' && 'âœ… Yes' || 'â¬œ No' }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Database: ${{ needs.detect-changes.outputs.database == 'true' && 'âœ… Yes' || 'â¬œ No' }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Frontend: ${{ needs.detect-changes.outputs.frontend == 'true' && 'âœ… Yes' || 'â¬œ No' }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Backend: ${{ needs.detect-changes.outputs.backend == 'true' && 'âœ… Yes' || 'â¬œ No' }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Workflows: ${{ needs.detect-changes.outputs.workflows == 'true' && 'âœ… Yes' || 'â¬œ No' }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY

#           echo "## Job Results" >> $GITHUB_STEP_SUMMARY
#           echo "- Setup Prerequisites: ${{ needs.setup-prerequisites.result == 'success' && 'âœ… Success' || needs.setup-prerequisites.result == 'skipped' && 'â­ï¸ Skipped' || needs.setup-prerequisites.result == 'failure' && 'âŒ Failed' || 'â¬œ Not Run' }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Build Frontend: ${{ needs.build-frontend.result == 'success' && 'âœ… Success' || needs.build-frontend.result == 'skipped' && 'â­ï¸ Skipped' || needs.build-frontend.result == 'failure' && 'âŒ Failed' || 'â¬œ Not Run' }}" >> $GITHUB_STEP_SUMMARY
#           echo "- Build Backend: ${{ needs.build-backend.result == 'success' && 'âœ… Success' || needs.build-backend.result == 'skipped' && 'â­ï¸ Skipped' || needs.build-backend.result == 'failure' && 'âŒ Failed' || 'â¬œ Not Run' }}" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY

#           # Overall status
#           if [ "${{ needs.build-frontend.result }}" == "failure" ] || [ "${{ needs.build-backend.result }}" == "failure" ]; then
#             echo "## âŒ Overall Status: Failed" >> $GITHUB_STEP_SUMMARY
#             exit 1
#           elif [ "${{ needs.build-frontend.result }}" == "cancelled" ] || [ "${{ needs.build-backend.result }}" == "cancelled" ]; then
#             echo "## âš ï¸ Overall Status: Cancelled" >> $GITHUB_STEP_SUMMARY
#           else
#             echo "## âœ… Overall Status: Success" >> $GITHUB_STEP_SUMMARY
#           fi
