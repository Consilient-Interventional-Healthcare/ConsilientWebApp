# Runtime Dependencies
# This workflow requires the following tools to be available in the runner environment:
# - SchemaSpy JAR: /opt/schemaspy/schemaspy.jar (version controlled via SCHEMASPY_VERSION)
# - JDBC Driver: /opt/schemaspy/mssql-jdbc.jar (SQL Server driver)
# - Java: 17+ (for running SchemaSpy)
# - sqlcmd: Azure SQL command-line tool (for schema discovery)
# - jq: JSON query tool (for parsing JSON input)
# - MSAL4J and Azure AD dependencies: Pre-installed in runner image for Azure authentication
# Note: Most are pre-installed in the GitHub Actions runner image

name: Generate Database Documentation

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment (dev or prod)'
        required: false
        type: string
        default: 'dev'
      database-configs:
        description: 'JSON array of database config objects (from centralized discovery)'
        required: false
        type: string
        default: '[]'
      azure-sql-server-fqdn:
        description: 'Azure SQL Server FQDN (fully qualified domain name)'
        required: true
        type: string
      runner_image:
        description: 'Custom runner container image with sqlcmd and other tools pre-installed'
        required: true
        type: string
      deploy-to-pages:
        description: 'Whether to deploy generated documentation to GitHub Pages'
        required: false
        type: boolean
        default: true
    secrets:
      ARM_CLIENT_ID:
        required: false
        description: 'Azure Service Principal Client ID for OIDC authentication'
      ARM_TENANT_ID:
        required: false
        description: 'Azure Tenant ID for OIDC authentication'
      AZURE_SUBSCRIPTION_ID:
        required: false
        description: 'Azure Subscription ID for OIDC authentication'
      ARM_CLIENT_SECRET:
        required: false
        description: 'Azure Client Secret for local testing with act (fallback)'

permissions:
  contents: read
  id-token: write
  pages: write

env:
  SQL_SERVER: ${{ inputs.azure-sql-server-fqdn }}
  SCHEMASPY_VERSION: '6.2.4'
  JDBC_VERSION: '12.4.2.jre11'
  SCHEMASPY_TIMEOUT_SECONDS: 600
  SCHEMA_DISCOVERY_TIMEOUT_SECONDS: 60
  MAX_CONCURRENT_SCHEMAS: 4

jobs:
  extract-databases:
    name: Extract Database Names
    runs-on: ubuntu-latest
    outputs:
      databases: ${{ steps.extract.outputs.databases }}
    steps:
      - name: Extract database names from config object
        id: extract
        run: |
          set -e

          CONFIGS='${{ inputs.database-configs }}'

          # Handle empty or invalid configs
          if [ -z "$CONFIGS" ] || [ "$CONFIGS" = "{}" ] || [ "$CONFIGS" = "[]" ]; then
            echo "databases=[]" >> $GITHUB_OUTPUT
            echo "âœ… No databases to extract"
            exit 0
          fi

          # Extract database names (keys) from the config object
          DB_NAMES=$(echo "$CONFIGS" | jq -c 'keys' 2>/dev/null || echo "[]")
          echo "databases=$DB_NAMES" >> $GITHUB_OUTPUT

          echo "âœ… Extracted database names: $DB_NAMES"

  generate-all-db-docs:
    name: Generate Docs for All Databases
    needs: [extract-databases]
    if: needs.extract-databases.outputs.databases != '[]'
    runs-on: ubuntu-latest
    container:
      image: ${{ inputs.runner_image }}
      credentials:
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    timeout-minutes: 90
    permissions:
      contents: read
      pages: write
      id-token: write
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Initialize database list
        id: init-databases
        run: |
          set -e

          DATABASES='${{ needs.extract-databases.outputs.databases }}'

          # Validate we have databases
          if [ -z "$DATABASES" ] || [ "$DATABASES" = "[]" ]; then
            echo "âŒ ERROR: No databases to process"
            exit 1
          fi

          # Export for use in subsequent steps
          echo "DATABASES_JSON=$DATABASES" >> $GITHUB_ENV

          # Count databases
          DB_COUNT=$(echo "$DATABASES" | jq -r 'length')
          echo "DATABASE_COUNT=$DB_COUNT" >> $GITHUB_ENV

          echo "âœ… Initialized $DB_COUNT database(s) for processing"
          echo "$DATABASES" | jq -r '.[]' | sed 's/^/  - /'

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Login to Azure (OIDC + act fallback)
        uses: ./.github/actions/azure-login
        with:
          client-id: ${{ secrets.ARM_CLIENT_ID }}
          tenant-id: ${{ secrets.ARM_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          client-secret: ${{ secrets.ARM_CLIENT_SECRET || '' }}

      - name: Process all databases
        id: process-databases
        shell: bash
        env:
          DATABASES_JSON: ${{ env.DATABASES_JSON }}
          SQL_SERVER: ${{ inputs.azure-sql-server-fqdn }}
          DATABASE_CONFIGS: ${{ inputs.database-configs }}
          SCHEMA_DISCOVERY_TIMEOUT_SECONDS: 120
          SCHEMASPY_TIMEOUT_SECONDS: 1800
          MAX_CONCURRENT_SCHEMAS: 4
          environment_input: ${{ inputs.environment }}
        run: |
          chmod +x .github/workflows/database-docs/process-all-databases.sh
          .github/workflows/database-docs/process-all-databases.sh

      - name: Create unified index page
        if: steps.process-databases.outcome == 'success'
        shell: bash
        env:
          DATABASE_COUNT: ${{ env.DATABASE_COUNT }}
          environment_input: ${{ inputs.environment }}
        run: |
          chmod +x .github/workflows/database-docs/generate-index.sh
          .github/workflows/database-docs/generate-index.sh

      - name: Add .nojekyll file for GitHub Pages
        if: steps.process-databases.outcome == 'success'
        run: |
          touch docs/.nojekyll
          echo "âœ… Added .nojekyll file to prevent Jekyll processing"

      - name: Upload to GitHub Pages
        if: steps.process-databases.outcome == 'success' && inputs.deploy-to-pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'
          retention-days: 1

      - name: Deploy to GitHub Pages
        id: deployment
        if: steps.process-databases.outcome == 'success' && inputs.deploy-to-pages
        uses: actions/deploy-pages@v4

      - name: Generate workflow summary
        if: always()
        run: |
          echo "## ðŸ“š Database Documentation Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.process-databases.outcome }}" = "success" ]; then
            echo "âœ… Documentation successfully generated for all databases" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Documentation generation failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Databases Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f /tmp/database_info.txt ]; then
            while IFS='|' read -r db_name actual_db_name schemas; do
              schema_count=$(echo "$schemas" | wc -w)
              echo "- ðŸ—„ï¸ **$db_name** ($actual_db_name) - $schema_count schema(s)" >> $GITHUB_STEP_SUMMARY
            done < /tmp/database_info.txt
          else
            echo "- _No databases processed_" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.deployment.outcome }}" = "success" ]; then
            echo "âœ… Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "View at: [GitHub Pages](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
          fi
